(ns adventoc.twentytwentyone.fifteen.chiton-test
  (:require
   [adventoc.twentytwentyone.fifteen.chiton :as core]
   [clojure.string :as str]
   [clojure.test :refer :all]))

(def puzzle
  (str/join "\n"
    ["1163751742"
     "1381373672"
     "2136511328"
     "3694931569"
     "7463417111"
     "1319128137"
     "1359912421"
     "3125421639"
     "1293138521"
     "2311944581"]))

(deftest input->graph-test
  (testing "input->graph returns correct dimensions"
    (let [g (core/input->graph puzzle)]
      (is (= [10 10]
             [(count (first g))
              (count g)])))))

(deftest dijkstra-test
  (testing "dijkstra produces expected distance and predecessor maps"
    (let [g (core/input->graph puzzle)
          {:keys [distances predecessors]} (core/dijkstra g [0 0])]
      (is (= {[8 8] 38 [7 6] 32 [8 7] 36 [9 8] 39 [7 1] 29 [8 9] 46 [4 3] 26
              [2 2] 7 [0 0] 0 [3 9] 26 [7 7] 35 [2 8] 30 [1 0] 1 [8 4] 28
              [2 3] 16 [2 5] 18 [7 2] 23 [6 7] 29 [7 4] 27 [8 3] 31 [0 6] 15
              [3 3] 17 [5 4] 23 [1 1] 4 [6 3] 21 [0 5] 14 [3 4] 20 [7 3] 26
              [8 6] 33 [4 2] 18 [7 8] 40 [3 0] 10 [9 0] 36 [6 6] 28 [9 6] 34
              [1 9] 24 [5 3] 22 [9 9] 40 [9 3] 38 [4 7] 30 [4 9] 35 [2 9] 25
              [6 5] 33 [0 9] 21 [8 0] 34 [4 1] 14 [5 2] 19 [4 6] 34 [1 4] 14
              [5 7] 28 [8 2] 25 [1 3] 10 [4 8] 30 [1 5] 17 [1 8] 21 [1 7] 19
              [6 4] 28 [8 1] 32 [0 3] 6 [5 1] 21 [6 1] 23 [5 6] 26 [5 8] 31
              [8 5] 31 [0 7] 18 [6 8] 37 [5 5] 25 [7 9] 44 [2 7] 21 [5 9] 35
              [2 4] 20 [3 6] 32 [9 2] 33 [4 5] 25 [9 1] 34 [9 7] 43 [7 0] 30
              [0 2] 3 [6 9] 39 [2 0] 7 [0 4] 13 [3 1] 11 [2 1] 12 [9 5] 36
              [3 8] 29 [9 4] 29 [1 6] 18 [4 4] 24 [3 7] 26 [7 5] 28 [2 6] 23
              [5 0] 22 [6 2] 20 [6 0] 23 [1 2] 4 [3 5] 27 [0 8] 19 [3 2] 13
              [0 1] 1 [4 0] 17}
             distances))
      (is (= {[8 8] [8 7] [7 6] [6 6] [8 7] [8 6] [9 8] [8 8] [7 1] [7 2]
              [8 9] [8 8] [4 3] [3 3] [2 2] [1 2] [3 9] [2 9] [7 7] [6 7]
              [2 8] [2 7] [1 0] [0 0] [8 4] [7 4] [2 3] [2 2] [2 5] [1 5]
              [7 2] [6 2] [6 7] [6 6] [7 4] [7 3] [8 3] [8 2] [0 6] [0 5]
              [3 3] [3 2] [5 4] [5 3] [1 1] [1 0] [6 3] [6 2] [0 5] [0 4]
              [3 4] [3 3] [7 3] [6 3] [8 6] [8 5] [4 2] [3 2] [7 8] [7 7]
              [3 0] [2 0] [9 0] [8 0] [6 6] [5 6] [9 6] [8 6] [1 9] [1 8]
              [5 3] [5 2] [9 9] [9 8] [9 3] [9 4] [4 7] [3 7] [4 9] [3 9]
              [2 9] [1 9] [6 5] [5 5] [0 9] [0 8] [8 0] [7 0] [4 1] [3 1]
              [5 2] [4 2] [4 6] [4 5] [1 4] [1 3] [5 7] [5 6] [8 2] [7 2]
              [1 3] [1 2] [4 8] [3 8] [1 5] [1 4] [1 8] [1 7] [1 7] [1 6]
              [6 4] [6 3] [8 1] [8 2] [0 3] [0 2] [5 1] [4 1] [6 1] [6 2]
              [5 6] [5 5] [5 8] [5 7] [8 5] [8 4] [0 7] [0 6] [6 8] [6 7]
              [5 5] [5 4] [7 9] [6 9] [2 7] [1 7] [5 9] [5 8] [2 4] [1 4]
              [3 6] [2 6] [9 2] [8 2] [4 5] [4 4] [9 1] [8 1] [9 7] [9 6]
              [7 0] [6 0] [0 2] [0 1] [6 9] [5 9] [2 0] [1 0] [0 4] [0 3]
              [3 1] [3 0] [2 1] [1 1] [9 5] [9 4] [3 8] [3 7] [9 4] [8 4]
              [1 6] [0 6] [4 4] [3 4] [3 7] [2 7] [7 5] [7 4] [2 6] [1 6]
              [5 0] [4 0] [6 2] [5 2] [6 0] [5 0] [1 2] [0 2] [3 5] [2 5]
              [0 8] [0 7] [3 2] [2 2] [0 1] [0 0] [4 0] [3 0]}
             predecessors)))))

(deftest chiton-test
  (testing "chiton produces correct path"
    (is (= [1 2 1 3 6 5 1 1 1 5 1 1 3 2 3 2 1 1]
           (core/chiton puzzle)))))

(deftest graph-rows-columns-switch-test
  (testing "graphs can have rows and columns switched"
    (let [g [[1 3 8]
             [2 1 3]]]
      (is (= [[1 2]
              [3 1]
              [8 3]]
             (core/graph-rows-columns-switch g))))
    (let [g [[1 2]
             [3 1]
             [8 3]]]
      (is (=
            [[1 3 8]
             [2 1 3]]
            (core/graph-rows-columns-switch g))))))

(deftest graph-times-test
  (testing "graphs can be multiplied"
    (let [g [[1 1 6]
             [1 3 8]
             [2 1 3]]]
      (is (=
            [[1 1 6 2 2 7 3 3 8]
             [1 3 8 2 4 9 3 5 1]
             [2 1 3 3 2 4 4 3 5]
             [2 2 7 3 3 8 4 4 9]
             [2 4 9 3 5 1 4 6 2]
             [3 2 4 4 3 5 5 4 6]
             [3 3 8 4 4 9 5 5 1]
             [3 5 1 4 6 2 5 7 3]
             [4 3 5 5 4 6 6 5 7]]
            (core/graph-times g 3))))))

(deftest chiton-5x-sum-test
  (testing "chiton produces correct result, 5x graph"
    (is (= 315
           (apply + (core/chiton puzzle 5))))))
